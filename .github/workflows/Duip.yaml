name: Filter JP IPs with Open 443 Port

on:
  workflow_dispatch:  # 手动触发工作流

jobs:
  filter-jp-ips:
    name: Filter and Check IPs
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu 环境
    permissions:
      contents: write  # 提交权限
      actions: read
      id-token: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # 拉取代码仓库

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq netcat-openbsd

      - name: Filter JP IPs and Check Multiple Ports
        run: |
          # 清空输出文件
          > open_ips.txt
          # 遍历 IP 文件
          while read -r ip; do
              # 仅提取 IP 地址
              clean_ip=$(echo "$ip" | awk -F'#' '{print $1}')
                if nc -z -w2 "$clean_ip" 443; then
                  # 如果端口通，写入文件
                  echo "$clean_ip:443#Japan" >> open_ips.txt
                  echo "$clean_ip ✅"
                else
                  echo "$ip ❌"
                fi
          done < jp_ips.txt

      - name: Commit and Push Results
        run: |
          date > generated.txt
          # Note: the following account information will not work on GHES
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 添加和提交更改
          git add open_ips.txt
          git commit -m "Add filtered JP IPs with open"

          # 推送到仓库
          git push
